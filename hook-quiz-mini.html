<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/async.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">

<dom-module id="hook-quiz-mini">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        overflow-y: hidden;
      }

      p {
        font-size: 2em;
        line-height: 1em;
      }

      paper-ripple {
        color: rgba(0, 0, 128, .5);
      }

      paper-progress {
        width: 100%;
        --paper-progress-active-color: navy;
        --paper-progress-transition-duration: .8s;
        --paper-progress-transition-timing-functionf: cubic-bezier(.67, .01, .28, 1);
      }

      paper-radio-group {
        display: flex;
        flex-direction: column;
      }

      paper-button {
        background: navy;
        color: white;
      }

      .enter-animation {
        animation: fadeIn .8s cubic-bezier(.67, .01, .28, 1);
      }

      .exit-animation {
        animation: fadeOut .8s cubic-bezier(.67, .01, .28, 1);
      }

      .enter-animation p {
        animation: staggerUp .6s cubic-bezier(.67, .01, .28, 1);
      }

      .exit-animation p {
        animation: staggerDown .6s cubic-bezier(.67, .01, .28, 1) .2s;
      }

      .enter-animation .choices {
        animation: staggerUp .6s cubic-bezier(.67, .01, .28, 1) .2s;
      }

      .exit-animation .choices {
        animation: staggerDown .6s cubic-bezier(.67, .01, .28, 1);
      }

      .enter-animation .reset-button {
        animation: fadeIn .6s cubic-bezier(.67, .01, .28, 1), staggerUp .6s cubic-bezier(.67, .01, .28, 1) .2s;
      }

/*      .exit-animation .reset-button {
        animation: staggerDown .6s cubic-bezier(.67, .01, .28, 1);
      }*/

      @keyframes fadeIn {
        0% {
          opacity: 0;
        }

        100% {
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        0% {
          opacity: 1;
        }

        100% {
          opacity: 0;
        }
      }

      @keyframes staggerUp {
        0% {
          transform: translateY(125px);
        }

        100% {
          transform: translateY(0);
        }
      }

      @keyframes staggerDown {
        0% {
          transform: translateY(0);
        }

        100% {
          transform: translateY(125px);
        }
      }
    </style>
    <paper-ripple id="ripple" recenters></paper-ripple>
    <paper-progress class="transiting" value="[[_getProgress(currentQuestion, totalQuestions)]]"></paper-progress>
    <iron-pages activate-event="" attr-for-selected="id" selected="[[page]]" id="pages">
      <div id="questions">
        <p>[[question.text]]</p>
        <paper-radio-group class="choices" selected="[[response]]" on-paper-radio-group-changed="_setResponse">
          <template is="dom-repeat" items="[[question.choices]]" as="choice">
            <paper-radio-button name="[[choice.text]]" noink>[[choice.text]]</paper-radio-button>
          </template>
        </paper-radio-group>
      </div>
      <div id="score">
        <p>You scored [[score]]%!</p>
        <paper-button raised on-click="_reset" class="reset-button" noink>Reset</paper-button>
      </div>
    </iron-pages>
  </template>

  <script>
    /**
     * `hook-quiz-mini`
     * does my element stuff
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class HookQuizMini extends Polymer.Element {
      static get is() { return 'hook-quiz-mini'; }
      static get properties() {
        return {
          questions: {
            type: Array,
            value: () => [],
            observer: '_reset'
          },
          answers: {
            type: Array,
            computed: '_getAnswers(questions)'
          },
          responses: {
            type: Array,
            value: () => []
          },
          currentQuestion: {
            type: Number,
            value: 0
          },
          totalQuestions: {
            type: Number,
            computed: '_getTotalQuestions(questions)'
          },
          question: {
            type: Object,
            computed: '_getQuestion(questions, currentQuestion)'
          },
          response: {
            type: String,
            computed: '_getResponse(responses, currentQuestion)'
          },
          score: {
            type: Number,
            computed: '_getScore(answers, responses, totalQuestions)'
          },
          page: {
            type: String,
            computed: '_getPage(currentQuestion, totalQuestions)'
          }
        };
      }

      _reset() {
        this.currentQuestion = 0;
        this.responses = this.questions.map(question => null);
      }

      _getAnswers(questions) {
        return this.questions.map(question => (
          question.choices.filter(choice => choice.correct)[0]
        ));
      }

      _getTotalQuestions(questions) {
        return questions.length;
      }

      _getProgress(currentQuestion, totalQuestions) {
        return currentQuestion / totalQuestions * 100;
      }

      _getQuestion(questions, currentQuestion) {
        return questions[currentQuestion];
      }

      _getResponse(responses, currentQuestion) {
        return responses[currentQuestion];
      }

      _getScore(answers, responses, totalQuestions) {
        const correct = responses.reduce((acc, response, index) => (
          acc + (answers[index] && response === answers[index].text)
        ), 0);
        return Math.round(correct / totalQuestions * 100);
      }

      _setResponse(e) {
        this.$.questions.classList.remove('enter-animation');
        this.$.questions.classList.add('exit-animation');

        const setAnimations = (e) => {
          const currentQuestion = this.currentQuestion;
          this.responses = this.responses.map((response, index) => (
            response = (index === currentQuestion) ? e.target.selected : response
          ));
          this.currentQuestion++;

          this.$.questions.classList.remove('exit-animation');
          this.$.questions.classList.add('enter-animation');


          this.$.questions.removeEventListener('animationend', setAnimations, false);
        }

        this.$.questions.addEventListener('animationend', setAnimations, false);
      }

      _getPage(currentQuestion, totalQuestions) {
        const setAnimations = (e) => {
          this.$.pages.items.forEach((item) => {
            if(item.classList.contains('iron-selected')) {
              item.classList.add('enter-animation');
            } else {
              item.classList.remove('enter-animation');
            }
          });

          this.$.pages.removeEventListener('iron-select', setAnimations, false);
        }

        this.$.pages.addEventListener('iron-select', setAnimations, false);

        return currentQuestion < totalQuestions ? 'questions' : 'score';
      }
    }

    window.customElements.define(HookQuizMini.is, HookQuizMini);
  </script>
</dom-module>
